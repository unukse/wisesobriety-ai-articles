<!DOCTYPE html>
<html>
  <head>
    <title>Reset Password</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  </head>
  <body>
    <h1>Set a new password</h1>
    <input type="password" id="new-password" placeholder="New password" />
    <button onclick="resetPassword()">Reset Password</button>

    <script>
      // Supabase credentials
      const supabaseUrl = 'https://nzmtiwjdtcgzifxygxsa.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56bXRpd2pkdGNnemlmeHlneHNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1NTUyMzEsImV4cCI6MjA2NzEzMTIzMX0.vJxUHnLPvjBjM7hh3xk4cQlGj-hKrDze12eNk10BzSg';
      
      const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

      async function resetPassword() {
        try {
          const hash = window.location.hash;
          console.log('Hash:', hash);
          
          const params = new URLSearchParams(hash.replace('#', '?'));
          const access_token = params.get('access_token');
          const refresh_token = params.get('refresh_token');

          console.log('Access token:', access_token ? 'Present' : 'Missing');
          console.log('Refresh token:', refresh_token ? 'Present' : 'Missing');

          if (!access_token) {
            alert("Missing access token. Please check the URL parameters.");
            console.error('No access token found in URL');
            return;
          }

          const { error: sessionError } = await supabase.auth.setSession({
            access_token,
            refresh_token: refresh_token || ''
          });

          if (sessionError) {
            console.error('Session error:', sessionError);
            alert("Failed to set session: " + sessionError.message);
            return;
          }

          const newPassword = document.getElementById('new-password').value;
          
          if (!newPassword || newPassword.length < 6) {
            alert("Please enter a password with at least 6 characters.");
            return;
          }

          const { error } = await supabase.auth.updateUser({
            password: newPassword
          });

          if (error) {
            console.error('Update user error:', error);
            alert("Failed to reset password: " + error.message);
          } else {
            alert("Password updated successfully!");
            window.location.href = 'password-updated.html';
          }
        } catch (error) {
          console.error('Unexpected error:', error);
          alert("An unexpected error occurred: " + error.message);
        }
      }
    </script>
  </body>
</html> 