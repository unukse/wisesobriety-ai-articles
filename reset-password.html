<!DOCTYPE html>
<html>
  <head>
    <title>Reset Password</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 2rem;
        text-align: center;
        background: #f8f9fa;
      }
      
      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      input {
        width: 100%;
        padding: 0.75rem;
        margin: 1rem 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
      }
      
      button {
        background: #007acc;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        margin: 1rem 0;
      }
      
      button:hover {
        background: #005f99;
      }
      
      .error {
        background: #ffebee;
        border: 1px solid #f44336;
        color: #c62828;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
      }
      
      .success {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        color: #2e7d32;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
      }
      
      .info {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        color: #1565c0;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Set a new password</h1>
      
      <div id="error-message" class="error" style="display: none;"></div>
      <div id="success-message" class="success" style="display: none;"></div>
      <div id="info-message" class="info" style="display: none;"></div>
      
      <div id="password-form">
        <input type="password" id="new-password" placeholder="New password" />
        <button onclick="resetPassword()">Reset Password</button>
      </div>
    </div>

    <script>
      // Supabase credentials
      const supabaseUrl = 'https://nzmtiwjdtcgzifxygxsa.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56bXRpd2pkdGNnemlmeHlneHNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1NTUyMzEsImV4cCI6MjA2NzEzMTIzMX0.vJxUHnLPvjBjM7hh3xk4cQlGj-hKrDze12eNk10BzSg';
      
      const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

      // Check for tokens on page load
      window.onload = function() {
        const hash = window.location.hash;
        const params = new URLSearchParams(hash.replace('#', '?'));
        const access_token = params.get('access_token');
        
        if (!access_token) {
          showError("Missing access token. This page should only be accessed via the password reset link sent to your email. Please check your email for the reset link.");
          document.getElementById('password-form').style.display = 'none';
        } else {
          showInfo("Access token found. You can now set your new password.");
        }
      };

      function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }

      function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
      }

      function showInfo(message) {
        const infoDiv = document.getElementById('info-message');
        infoDiv.textContent = message;
        infoDiv.style.display = 'block';
      }

      async function resetPassword() {
        try {
          const hash = window.location.hash;
          console.log('Hash:', hash);
          
          const params = new URLSearchParams(hash.replace('#', '?'));
          const access_token = params.get('access_token');
          const refresh_token = params.get('refresh_token');

          console.log('Access token:', access_token ? 'Present' : 'Missing');
          console.log('Refresh token:', refresh_token ? 'Present' : 'Missing');

          if (!access_token) {
            showError("Missing access token. Please check the URL parameters.");
            console.error('No access token found in URL');
            return;
          }

          const { error: sessionError } = await supabase.auth.setSession({
            access_token,
            refresh_token: refresh_token || ''
          });

          if (sessionError) {
            console.error('Session error:', sessionError);
            showError("Failed to set session: " + sessionError.message);
            return;
          }

          const newPassword = document.getElementById('new-password').value;
          
          if (!newPassword || newPassword.length < 6) {
            showError("Please enter a password with at least 6 characters.");
            return;
          }

          const { error } = await supabase.auth.updateUser({
            password: newPassword
          });

          if (error) {
            console.error('Update user error:', error);
            showError("Failed to reset password: " + error.message);
          } else {
            showSuccess("Password updated successfully!");
            document.getElementById('password-form').style.display = 'none';
            setTimeout(() => {
              window.location.href = 'password-updated.html';
            }, 2000);
          }
        } catch (error) {
          console.error('Unexpected error:', error);
          showError("An unexpected error occurred: " + error.message);
        }
      }
    </script>
  </body>
</html> 